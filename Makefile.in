# Emacs Makefile for TRAMP
# @configure_input@

# Copyright (C) 1998, 1999, 2000, 2001, 2002, 2003, 2004 Free Software Foundation, Inc.

# Author: kai.grossjohann@gmx.net
#         Michael.Albinus@alcatel.de
# Keywords: comm, processes

# This file is part of GNU Emacs.

# GNU Emacs is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.

# GNU Emacs is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with GNU Emacs; see the file COPYING.  If not, write to the
# Free Software Foundation, Inc., 59 Temple Place - Suite 330,
# Boston, MA 02111-1307, USA.

# This Makefile requires GNU make and GNU tar.

# If we seem to be in an XEmacs package hierarchy, build packages.
# Otherwise, use the upstream rules.
# #### I don't think we need to strip the result of $(wildcard ...)
ifeq (,$(wildcard ../../XEmacs.rules))

# This is not an XEmacs package.

# N.B.  Configuration of utilities for XEmacs packages is done in
# ../../Local.rules.  These have no effect on XEmacs's package build
# process (and thus live inside the conditional).

@SET_MAKE@
EMACS		= @EMACS@
EMACS_INFO	= @EMACS_INFO@
MAKEINFO	= @MAKEINFO@
RM		= -rm -f

DIRS		= lisp texi

CONFIG_FILES	= @TRAMP_CONFIG_FILES@
CLEAN_FILES	= @TRAMP_CLEAN_FILES@

# To be used by maintainer only
VERSION		= $(subst .,-,@PACKAGE_VERSION@)
TARNAME		= @PACKAGE_TARNAME@-@PACKAGE_VERSION@
XEMACS_TARGET	= ../xemacs/packages/xemacs-packages/tramp
EMACS_TARGET	= ../emacs
# Can't use wildcard tramp-*.el since that would catch tramp-efs.el,
# too, which isn't included in Emacs.
EMACS_EL_FILES = lisp/tramp.el lisp/tramp-ftp.el lisp/tramp-smb.el	\
		lisp/tramp-util.el lisp/tramp-uu.el lisp/tramp-vc.el	\
		lisp/trampver.el
EMACS_TEXI_FILES = texi/tramp.texi texi/trampver.texi
TRAMP_EMACS_MERGE_VERSION = @TRAMP_EMACS_MERGE_VERSION@
TRAMP_EMACS_MERGE_TAG = $(subst .,-,V-@TRAMP_EMACS_MERGE_VERSION@)

# Decrease noise
.SILENT: all install clean info

.PHONY: all install clean distclean info tags		\
	maintainer-clean cvstag MANIFEST tar xemacs	\
	emacs savannah cvs-update

all install: $(CONFIG_FILES)
	for a in ${DIRS}; do				\
	    $(MAKE) -C $$a "EMACS=$(EMACS)"		\
	    "EMACS_INFO=$(EMACS_INFO)" $(MAKECMDGOALS);	\
	done

clean:
	$(RM) $(CLEAN_FILES)
	for a in ${DIRS} contrib; do			\
	    $(MAKE) -C $$a clean;			\
	done

distclean: clean
	for a in ${DIRS} contrib; do			\
	    $(MAKE) -C $$a distclean;			\
	done
	$(RM) $(CONFIG_FILES) MANIFEST *.tar.gz*
	$(RM) -r autom4te.cache info

info:
	$(MAKE) -C texi "EMACS=$(EMACS)"		\
	    "EMACS_INFO=$(EMACS_INFO)" all

tags:
	etags lisp/*.el texi/*.texi

# Maintainer targets

maintainer-clean: distclean
	$(RM) configure config.status

cvstag:
	cvs tag V-$(VERSION)

# Depends on configure in order to run autoconf.  All files
# which shall be produced on customer host, should be removed.
MANIFEST: configure distclean
	find . \( -name CVS  -prune \)			\
	    -o \( -name info -prune \)			\
	    -o \( -name tmp  -prune \)			\
	    -o \( -type f \! -name *,v \)		\
	    -print > MANIFEST

tar: MANIFEST
	mkdir $(TARNAME)
	tar cpfT - MANIFEST | ( cd $(TARNAME) ; tar xpf - )
	chmod -R a+r $(TARNAME)
	tar cvpfz $(TARNAME).tar.gz $(TARNAME)
	$(RM) -r $(TARNAME)
	gpg --detach-sign $(TARNAME).tar.gz
	chmod a+r $(TARNAME).tar.gz*

xemacs:
	./configure --with-packaging --with-xemacs
	$(MAKE) -C lisp XEMACS_TARGET=../$(XEMACS_TARGET) xemacs
	cp texi/tramp.texi texi/trampver.texi texi/ChangeLog \
	    $(XEMACS_TARGET)/texi
	cp test/*.el $(XEMACS_TARGET)/test
	cp ChangeLog $(XEMACS_TARGET)/ChangeLog.upstream
	-echo "Don't forget to update AUTHOR_VERSION in Makefile."

emacs:
	./configure --with-packaging --with-emacs;			     \
	cvs diff -u -r$(TRAMP_EMACS_MERGE_TAG) -rV-$(VERSION)		     \
		$(EMACS_EL_FILES) > tramp-emacs-merge.diff || true;	     \
	( cd $(EMACS_TARGET)/lisp/net; patch -p1 ) < tramp-emacs-merge.diff; \
	cvs diff -u -r$(TRAMP_EMACS_MERGE_TAG) -rV-$(VERSION)		     \
		$(EMACS_TEXI_FILES) > tramp-emacs-merge2.diff || true;	     \
	( cd $(EMACS_TARGET)/man; patch -p1 ) < tramp-emacs-merge2.diff;     \
	ls $(EMACS_TARGET)/lisp/net/*.rej >/dev/null 2>/dev/null &&	     \
		echo "WARNING!  Patch in lisp/net didn't apply cleanly.";    \
	ls $(EMACS_TARGET)/man/*.rej >/dev/null 2>/dev/null &&		     \
		echo "WARNING!  Patch in man didn't apply cleanly.";	     \
	echo "Don't forget to update the ChangeLog for Emacs.";		     \
	echo "Also remember to update Emacs merge revision in configure.ac."

# 	ftp-upload --host savannah.nongnu.org --dir incoming/savannah/tramp \
# 	    $(TARNAME).tar.gz*
savannah: tar cvstag
	ftp -u ftp://savannah.nongnu.org/incoming/savannah/tramp \
	    $(TARNAME).tar.gz*
	./configure --with-japanese-manual
	$(MAKE) -C texi savannah

cvs-update:
	cvs update -dP

# Targets updating files generated by autoconf and configure

$(CONFIG_FILES): $(CONFIG_FILES:=.in) config.status
	./config.status

config.status: configure
	./config.status --recheck

configure: aclocal.m4 configure.ac
	autoconf

else

# This is an XEmacs package.
include Makefile.XEmacs
endif
